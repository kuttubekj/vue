import{L as w,q as g,B as J,_ as f,M as ee,C as K,D as te,O as y,Q as p,R as A,V as se,H as ne}from"./index.42e490f5.js";import{v as X,J as re,A as D,g as ie}from"./alchemy-provider-ff61e9d1.0ce736eb.js";let N=null;try{if(N=WebSocket,N==null)throw new Error("inject please")}catch{const e=new w(X);N=function(){e.throwError("WebSockets not supported in this environment",w.errors.UNSUPPORTED_OPERATION,{operation:"new WebSocket()"})}}var M=globalThis&&globalThis.__awaiter||function(n,e,t,s){function r(o){return o instanceof t?o:new t(function(i){i(o)})}return new(t||(t=Promise))(function(o,i){function c(h){try{u(s.next(h))}catch(a){i(a)}}function l(h){try{u(s.throw(h))}catch(a){i(a)}}function u(h){h.done?o(h.value):r(h.value).then(c,l)}u((s=s.apply(n,e||[])).next())})};const S=new w(X);let oe=1;class ce extends re{constructor(e,t){t==="any"&&S.throwError("WebSocketProvider does not support 'any' network yet",w.errors.UNSUPPORTED_OPERATION,{operation:"network:any"}),typeof e=="string"?super(e,t):super("_websocket",t),this._pollingInterval=-1,this._wsReady=!1,typeof e=="string"?g(this,"_websocket",new N(this.connection.url)):g(this,"_websocket",e),g(this,"_requests",{}),g(this,"_subs",{}),g(this,"_subIds",{}),g(this,"_detectNetwork",super.detectNetwork()),this.websocket.onopen=()=>{this._wsReady=!0,Object.keys(this._requests).forEach(r=>{this.websocket.send(this._requests[r].payload)})},this.websocket.onmessage=r=>{const o=r.data,i=JSON.parse(o);if(i.id!=null){const c=String(i.id),l=this._requests[c];if(delete this._requests[c],i.result!==void 0)l.callback(null,i.result),this.emit("debug",{action:"response",request:JSON.parse(l.payload),response:i.result,provider:this});else{let u=null;i.error?(u=new Error(i.error.message||"unknown error"),g(u,"code",i.error.code||null),g(u,"response",o)):u=new Error("unknown error"),l.callback(u,void 0),this.emit("debug",{action:"response",error:u,request:JSON.parse(l.payload),provider:this})}}else if(i.method==="eth_subscription"){const c=this._subs[i.params.subscription];c&&c.processFunc(i.params.result)}else console.warn("this should not happen")};const s=setInterval(()=>{this.emit("poll")},1e3);s.unref&&s.unref()}get websocket(){return this._websocket}detectNetwork(){return this._detectNetwork}get pollingInterval(){return 0}resetEventsBlock(e){S.throwError("cannot reset events block on WebSocketProvider",w.errors.UNSUPPORTED_OPERATION,{operation:"resetEventBlock"})}set pollingInterval(e){S.throwError("cannot set polling interval on WebSocketProvider",w.errors.UNSUPPORTED_OPERATION,{operation:"setPollingInterval"})}poll(){return M(this,void 0,void 0,function*(){return null})}set polling(e){!e||S.throwError("cannot set polling on WebSocketProvider",w.errors.UNSUPPORTED_OPERATION,{operation:"setPolling"})}send(e,t){const s=oe++;return new Promise((r,o)=>{function i(l,u){return l?o(l):r(u)}const c=JSON.stringify({method:e,params:t,id:s,jsonrpc:"2.0"});this.emit("debug",{action:"request",request:JSON.parse(c),provider:this}),this._requests[String(s)]={callback:i,payload:c},this._wsReady&&this.websocket.send(c)})}static defaultUrl(){return"ws://localhost:8546"}_subscribe(e,t,s){return M(this,void 0,void 0,function*(){let r=this._subIds[e];r==null&&(r=Promise.all(t).then(i=>this.send("eth_subscribe",i)),this._subIds[e]=r);const o=yield r;this._subs[o]={tag:e,processFunc:s}})}_startEvent(e){switch(e.type){case"block":this._subscribe("block",["newHeads"],t=>{const s=J.from(t.number).toNumber();this._emitted.block=s,this.emit("block",s)});break;case"pending":this._subscribe("pending",["newPendingTransactions"],t=>{this.emit("pending",t)});break;case"filter":this._subscribe(e.tag,["logs",this._getFilter(e.filter)],t=>{t.removed==null&&(t.removed=!1),this.emit(e.filter,this.formatter.filterLog(t))});break;case"tx":{const t=s=>{const r=s.hash;this.getTransactionReceipt(r).then(o=>{!o||this.emit(r,o)})};t(e),this._subscribe("tx",["newHeads"],s=>{this._events.filter(r=>r.type==="tx").forEach(t)});break}case"debug":case"poll":case"willPoll":case"didPoll":case"error":break;default:console.log("unhandled:",e);break}}_stopEvent(e){let t=e.tag;if(e.type==="tx"){if(this._events.filter(r=>r.type==="tx").length)return;t="tx"}else if(this.listenerCount(e.event))return;const s=this._subIds[t];!s||(delete this._subIds[t],s.then(r=>{!this._subs[r]||(delete this._subs[r],this.send("eth_unsubscribe",[r]))}))}destroy(){return M(this,void 0,void 0,function*(){this.websocket.readyState===N.CONNECTING&&(yield new Promise(e=>{this.websocket.onopen=function(){e(!0)},this.websocket.onerror=function(){e(!1)}})),this.websocket.close(1e3)})}}var Q={};Object.defineProperty(Q,"__esModule",{value:!0});var le="Provided shouldReconnect() returned false. Closing permanently.",ue="Provided shouldReconnect() resolved to false. Closing permanently.",j=function(){function n(e,t,s){if(s===void 0&&(s={}),this.url=e,this.onclose=null,this.onerror=null,this.onmessage=null,this.onopen=null,this.ondown=null,this.onreopen=null,this.CONNECTING=n.CONNECTING,this.OPEN=n.OPEN,this.CLOSING=n.CLOSING,this.CLOSED=n.CLOSED,this.hasBeenOpened=!1,this.isClosed=!1,this.messageBuffer=[],this.nextRetryTime=0,this.reconnectCount=0,this.lastKnownExtensions="",this.lastKnownProtocol="",this.listeners={},t==null||typeof t=="string"||Array.isArray(t)?this.protocols=t:s=t,this.options=he(s),!this.options.wsConstructor)if(typeof WebSocket!="undefined")this.options.wsConstructor=WebSocket;else throw new Error("WebSocket not present in global scope and no wsConstructor option was provided.");this.openNewWebSocket()}return Object.defineProperty(n.prototype,"binaryType",{get:function(){return this.binaryTypeInternal||"blob"},set:function(e){this.binaryTypeInternal=e,this.ws&&(this.ws.binaryType=e)},enumerable:!0,configurable:!0}),Object.defineProperty(n.prototype,"bufferedAmount",{get:function(){var e=this.ws?this.ws.bufferedAmount:0,t=!1;return this.messageBuffer.forEach(function(s){var r=de(s);r!=null?e+=r:t=!0}),t&&this.debugLog("Some buffered data had unknown length. bufferedAmount() return value may be below the correct amount."),e},enumerable:!0,configurable:!0}),Object.defineProperty(n.prototype,"extensions",{get:function(){return this.ws?this.ws.extensions:this.lastKnownExtensions},enumerable:!0,configurable:!0}),Object.defineProperty(n.prototype,"protocol",{get:function(){return this.ws?this.ws.protocol:this.lastKnownProtocol},enumerable:!0,configurable:!0}),Object.defineProperty(n.prototype,"readyState",{get:function(){return this.isClosed?n.CLOSED:n.OPEN},enumerable:!0,configurable:!0}),n.prototype.close=function(e,t){this.disposeSocket(e,t),this.shutdown(),this.debugLog("WebSocket permanently closed by client.")},n.prototype.send=function(e){if(this.isClosed)throw new Error("WebSocket is already in CLOSING or CLOSED state.");this.ws&&this.ws.readyState===this.OPEN?this.ws.send(e):this.messageBuffer.push(e)},n.prototype.reconnect=function(){if(this.isClosed)throw new Error("Cannot call reconnect() on socket which is permanently closed.");this.disposeSocket(1e3,"Client requested reconnect."),this.handleClose(void 0)},n.prototype.addEventListener=function(e,t){this.listeners[e]||(this.listeners[e]=[]),this.listeners[e].push(t)},n.prototype.dispatchEvent=function(e){return this.dispatchEventOfType(e.type,e)},n.prototype.removeEventListener=function(e,t){this.listeners[e]&&(this.listeners[e]=this.listeners[e].filter(function(s){return s!==t}))},n.prototype.openNewWebSocket=function(){var e=this;if(!this.isClosed){var t=this.options,s=t.connectTimeout,r=t.wsConstructor;this.debugLog("Opening new WebSocket to "+this.url+".");var o=new r(this.url,this.protocols);o.onclose=function(i){return e.handleClose(i)},o.onerror=function(i){return e.handleError(i)},o.onmessage=function(i){return e.handleMessage(i)},o.onopen=function(i){return e.handleOpen(i)},this.connectTimeoutId=setTimeout(function(){e.clearConnectTimeout(),e.disposeSocket(),e.handleClose(void 0)},s),this.ws=o}},n.prototype.handleOpen=function(e){var t=this;if(!(!this.ws||this.isClosed)){var s=this.options.allClearResetTime;this.debugLog("WebSocket opened."),this.binaryTypeInternal!=null?this.ws.binaryType=this.binaryTypeInternal:this.binaryTypeInternal=this.ws.binaryType,this.clearConnectTimeout(),this.hasBeenOpened?this.dispatchEventOfType("reopen",e):(this.dispatchEventOfType("open",e),this.hasBeenOpened=!0),this.messageBuffer.forEach(function(r){return t.send(r)}),this.messageBuffer=[],this.allClearTimeoutId=setTimeout(function(){t.clearAllClearTimeout(),t.nextRetryTime=0,t.reconnectCount=0;var r=s/1e3|0;t.debugLog("WebSocket remained open for "+r+" seconds. Resetting retry time and count.")},s)}},n.prototype.handleMessage=function(e){this.isClosed||this.dispatchEventOfType("message",e)},n.prototype.handleClose=function(e){var t=this;if(!this.isClosed){var s=this.options,r=s.maxReconnectAttempts,o=s.shouldReconnect;if(this.clearConnectTimeout(),this.clearAllClearTimeout(),this.ws&&(this.lastKnownExtensions=this.ws.extensions,this.lastKnownProtocol=this.ws.protocol,this.disposeSocket()),this.dispatchEventOfType("down",e),this.reconnectCount>=r){this.stopReconnecting(e,this.getTooManyFailedReconnectsMessage());return}var i=!e||o(e);typeof i=="boolean"?this.handleWillReconnect(i,e,le):i.then(function(c){t.isClosed||t.handleWillReconnect(c,e,ue)})}},n.prototype.handleError=function(e){this.dispatchEventOfType("error",e),this.debugLog("WebSocket encountered an error.")},n.prototype.handleWillReconnect=function(e,t,s){e?this.reestablishConnection():this.stopReconnecting(t,s)},n.prototype.reestablishConnection=function(){var e=this,t=this.options,s=t.minReconnectDelay,r=t.maxReconnectDelay,o=t.reconnectBackoffFactor;this.reconnectCount++;var i=this.nextRetryTime;this.nextRetryTime=Math.max(s,Math.min(this.nextRetryTime*o,r)),setTimeout(function(){return e.openNewWebSocket()},i);var c=i/1e3|0;this.debugLog("WebSocket was closed. Re-opening in "+c+" seconds.")},n.prototype.stopReconnecting=function(e,t){this.debugLog(t),this.shutdown(),e&&this.dispatchEventOfType("close",e)},n.prototype.shutdown=function(){this.isClosed=!0,this.clearAllTimeouts(),this.messageBuffer=[],this.disposeSocket()},n.prototype.disposeSocket=function(e,t){!this.ws||(this.ws.onerror=B,this.ws.onclose=B,this.ws.onmessage=B,this.ws.onopen=B,this.ws.close(e,t),this.ws=void 0)},n.prototype.clearAllTimeouts=function(){this.clearConnectTimeout(),this.clearAllClearTimeout()},n.prototype.clearConnectTimeout=function(){this.connectTimeoutId!=null&&(clearTimeout(this.connectTimeoutId),this.connectTimeoutId=void 0)},n.prototype.clearAllClearTimeout=function(){this.allClearTimeoutId!=null&&(clearTimeout(this.allClearTimeoutId),this.allClearTimeoutId=void 0)},n.prototype.dispatchEventOfType=function(e,t){var s=this;switch(e){case"close":this.onclose&&this.onclose(t);break;case"error":this.onerror&&this.onerror(t);break;case"message":this.onmessage&&this.onmessage(t);break;case"open":this.onopen&&this.onopen(t);break;case"down":this.ondown&&this.ondown(t);break;case"reopen":this.onreopen&&this.onreopen(t);break}return e in this.listeners&&this.listeners[e].slice().forEach(function(r){return s.callListener(r,t)}),!t||!t.defaultPrevented},n.prototype.callListener=function(e,t){typeof e=="function"?e.call(this,t):e.handleEvent.call(this,t)},n.prototype.debugLog=function(e){this.options.debug&&console.log(e)},n.prototype.getTooManyFailedReconnectsMessage=function(){var e=this.options.maxReconnectAttempts;return"Failed to reconnect after "+e+" "+fe("attempt",e)+". Closing permanently."},n.DEFAULT_OPTIONS={allClearResetTime:5e3,connectTimeout:5e3,debug:!1,minReconnectDelay:1e3,maxReconnectDelay:3e4,maxReconnectAttempts:Number.POSITIVE_INFINITY,reconnectBackoffFactor:1.5,shouldReconnect:function(){return!0},wsConstructor:void 0},n.CONNECTING=0,n.OPEN=1,n.CLOSING=2,n.CLOSED=3,n}(),ae=Q.default=j;function he(n){var e={};return Object.keys(j.DEFAULT_OPTIONS).forEach(function(t){var s=n[t];e[t]=s===void 0?j.DEFAULT_OPTIONS[t]:s}),e}function de(n){return typeof n=="string"?2*n.length:n instanceof ArrayBuffer?n.byteLength:n instanceof Blob?n.size:void 0}function fe(n,e){return e===1?n:n+"s"}function B(){}const v="alchemy-pending-transactions",T="alchemy-mined-transactions",O=[v,T];class pe{constructor(e,t,s){this.listener=t,this.tag=e,this.once=s,this._lastBlockNumber=-2,this._inflight=!1}get event(){switch(this.type){case"tx":return this.hash;case"filter":return this.filter;default:return this.tag}}get type(){return this.tag.split(":")[0]}get hash(){const e=this.tag.split(":");if(e[0]!=="tx")throw new Error("Not a transaction event");return e[1]}get filter(){const e=this.tag.split(":");if(e[0]!=="filter")throw new Error("Not a transaction event");const t=e[1],s=Ee(e[2]),r={};return s.length>0&&(r.topics=s),t&&t!=="*"&&(r.address=t),r}pollable(){const e=["block","network","pending","poll"];return this.tag.indexOf(":")>=0||e.indexOf(this.tag)>=0}}class be extends pe{get fromAddress(){const e=this.tag.split(":");if(e[0]===v&&e[1]&&e[1]!=="*")return Y(e[1])}get toAddress(){const e=this.tag.split(":");if(e[0]===v&&e[2]&&e[2]!=="*")return Y(e[2])}get hashesOnly(){const e=this.tag.split(":");if(!!O.includes(e[0])&&e[3]&&e[3]!=="*")return e[3]==="true"}get includeRemoved(){const e=this.tag.split(":");if(e[0]===T&&e[2]&&e[2]!=="*")return e[2]==="true"}get addresses(){const e=this.tag.split(":");if(e[0]===T&&e[1]&&e[1]!=="*")return we(e[1])}}function E(n){return typeof n=="object"&&"method"in n}function _(n){if(!E(n))throw new Error("Event tag requires AlchemyEventType");if(n.method===y.PENDING_TRANSACTIONS)return ge(n);if(n.method===y.MINED_TRANSACTIONS)return ye(n);throw new Error(`Unrecognized AlchemyFilterEvent: ${n}`)}function me(n){if(!Object.values(y).includes(n.method))throw new Error(`Invalid method name ${n.method}. Accepted method names: ${Object.values(y)}`)}function ge(n){const e=L(n.fromAddress),t=L(n.toAddress),s=U(n.hashesOnly);return v+":"+e+":"+t+":"+s}function ye(n){const e=ke(n.addresses),t=U(n.includeRemoved),s=U(n.hashesOnly);return T+":"+e+":"+t+":"+s}function ke(n){return n===void 0?"*":n.map(e=>L(e.to)+","+L(e.from)).join("|")}function L(n){return n===void 0?"*":Array.isArray(n)?n.join("|"):n}function U(n){return n===void 0?"*":n.toString()}function Ee(n){return n===""?[]:n.split(/&/g).map(e=>{if(e==="")return[];const t=e.split("|").map(s=>s==="null"?null:s);return t.length===1?t[0]:t})}function Y(n){if(n==="")return;const e=n.split("|");return e.length===1?e[0]:e}function we(n){if(n!=="")return n.split("|").map(e=>e.split(",")).map(e=>Object.assign(Object.assign({},e[0]!=="*"&&{to:e[0]}),e[1]!=="*"&&{from:e[1]}))}const _e=120;class ve{constructor(e){this.provider=e,this.maxBackfillBlocks=_e}getNewHeadsBackfill(e,t,s){return f(this,void 0,void 0,function*(){b(e);const r=yield this.getBlockNumber();if(b(e),t.length===0)return this.getHeadEventsInRange(Math.max(s,r-this.maxBackfillBlocks)+1,r+1);const o=p(t[t.length-1].number),i=r-this.maxBackfillBlocks+1;if(o<=i)return this.getHeadEventsInRange(i,r+1);const c=yield this.getReorgHeads(e,t);b(e);const l=yield this.getHeadEventsInRange(o+1,r+1);return b(e),[...c,...l]})}getLogsBackfill(e,t,s,r){return f(this,void 0,void 0,function*(){b(e);const o=yield this.getBlockNumber();if(b(e),s.length===0)return this.getLogsInRange(t,Math.max(r,o-this.maxBackfillBlocks)+1,o+1);const i=p(s[s.length-1].blockNumber),c=o-this.maxBackfillBlocks+1;if(i<c)return this.getLogsInRange(t,c,o+1);const l=yield this.getCommonAncestor(e,s);b(e);const u=s.filter(d=>p(d.blockNumber)>l.blockNumber).map(d=>Object.assign(Object.assign({},d),{removed:!0})),h=l.blockNumber===Number.NEGATIVE_INFINITY?p(s[0].blockNumber):l.blockNumber;let a=yield this.getLogsInRange(t,h,o+1);return a=a.filter(d=>d&&(p(d.blockNumber)>l.blockNumber||p(d.logIndex)>l.logIndex)),b(e),[...u,...a]})}setMaxBackfillBlock(e){this.maxBackfillBlocks=e}getBlockNumber(){return f(this,void 0,void 0,function*(){const e=yield this.provider.send("eth_blockNumber");return p(e)})}getHeadEventsInRange(e,t){return f(this,void 0,void 0,function*(){if(e>=t)return[];const s=[];for(let i=e;i<t;i++)s.push({method:"eth_getBlockByNumber",params:[A(i),!1]});return(yield this.provider.sendBatch(s)).reduce((i,c)=>i.concat(c),[]).map(q)})}getReorgHeads(e,t){return f(this,void 0,void 0,function*(){const s=[];for(let r=t.length-1;r>=0;r--){const o=t[r],i=yield this.getBlockByNumber(p(o.number));if(b(e),o.hash===i.hash)break;s.push(q(i))}return s.reverse()})}getBlockByNumber(e){return f(this,void 0,void 0,function*(){return this.provider.send("eth_getBlockByNumber",[A(e),!1])})}getCommonAncestor(e,t){return f(this,void 0,void 0,function*(){let s=yield this.getBlockByNumber(p(t[t.length-1].blockNumber));b(e);for(let r=t.length-1;r>=0;r--){const o=t[r];if(o.blockNumber!==s.number&&(s=yield this.getBlockByNumber(p(o.blockNumber))),o.blockHash===s.hash)return{blockNumber:p(o.blockNumber),logIndex:p(o.logIndex)}}return{blockNumber:Number.NEGATIVE_INFINITY,logIndex:Number.NEGATIVE_INFINITY}})}getLogsInRange(e,t,s){return f(this,void 0,void 0,function*(){if(t>=s)return[];const r=Object.assign(Object.assign({},e),{fromBlock:A(t),toBlock:A(s-1)});return this.provider.send("eth_getLogs",[r])})}}function q(n){const e=Object.assign({},n);return delete e.totalDifficulty,delete e.transactions,delete e.uncles,e}function Te(n){return Z(n,e=>e.hash)}function Ne(n){return Z(n,e=>`${e.blockHash}/${e.logIndex}`)}function Z(n,e){const t=new Set,s=[];return n.forEach(r=>{const o=e(r);t.has(o)||(t.add(o),s.push(r))}),s}const Ie=new Error("Cancelled");function b(n){if(n())throw Ie}const Ae=3e4,Se=1e4,z=6e4,V=5,Be=10;class Ge extends ce{constructor(e,t){var s;const r=D.getApiKey(e.apiKey),o=D.getAlchemyNetwork(e.network),i=D.getAlchemyConnectionInfo(o,r,"wss"),c=`alchemy-sdk-${se}`,l=new ae((s=e.url)!==null&&s!==void 0?s:i.url,c,{wsConstructor:t!=null?t:Oe()}),u=ne[o];super(l,u),this._events=[],this.virtualSubscriptionsById=new Map,this.virtualIdsByPhysicalId=new Map,this.handleMessage=h=>{const a=JSON.parse(h.data);if(!De(a))return;const d=a.params.subscription,m=this.virtualIdsByPhysicalId.get(d);if(!m)return;const I=this.virtualSubscriptionsById.get(m);if(I.method==="eth_subscribe")switch(I.params[0]){case"newHeads":{const P=I,x=a,{isBackfilling:H,backfillBuffer:F}=P,{result:k}=x.params;H?Me(F,k):d!==m?this.emitAndRememberEvent(m,k,R):this.rememberEvent(m,k,R);break}case"logs":{const P=I,x=a,{isBackfilling:H,backfillBuffer:F}=P,{result:k}=x.params;H?We(F,k):m!==d?this.emitAndRememberEvent(m,k,C):this.rememberEvent(m,k,C);break}}},this.handleReopen=()=>{this.virtualIdsByPhysicalId.clear();const{cancel:h,isCancelled:a}=Ce();this.cancelBackfill=h;for(const d of this.virtualSubscriptionsById.values())f(this,void 0,void 0,function*(){try{yield this.resubscribeAndBackfill(a,d)}catch(m){a()||console.error(`Error while backfilling "${d.params[0]}" subscription. Some events may be missing.`,m)}});this.startHeartbeat()},this.stopHeartbeatAndBackfill=()=>{this.heartbeatIntervalId!=null&&(clearInterval(this.heartbeatIntervalId),this.heartbeatIntervalId=void 0),this.cancelBackfill()},this.apiKey=r,this.backfiller=new ve(this),this.addSocketListeners(),this.startHeartbeat(),this.cancelBackfill=ee}static getNetwork(e){return typeof e=="string"&&e in K?K[e]:ie(e)}on(e,t){return this._addEventListener(e,t,!1)}once(e,t){return this._addEventListener(e,t,!0)}off(e,t){return E(e)?this._off(e,t):super.off(e,t)}removeAllListeners(e){return e!==void 0&&E(e)?this._removeAllListeners(e):super.removeAllListeners(e)}listenerCount(e){return e!==void 0&&E(e)?this._listenerCount(e):super.listenerCount(e)}listeners(e){return e!==void 0&&E(e)?this._listeners(e):super.listeners(e)}_addEventListener(e,t,s){if(E(e)){me(e);const r=new be(_(e),t,s);return this._events.push(r),this._startEvent(r),this}else return super._addEventListener(e,t,s)}_startEvent(e){[...O,"block","filter"].includes(e.type)?this.customStartEvent(e):super._startEvent(e)}_subscribe(e,t,s,r){return f(this,void 0,void 0,function*(){let o=this._subIds[e];const i=yield this.getBlockNumber();o==null&&(o=Promise.all(t).then(u=>this.send("eth_subscribe",u)),this._subIds[e]=o);const c=yield o,l=yield Promise.all(t);this.virtualSubscriptionsById.set(c,{event:r,method:"eth_subscribe",params:l,startingBlockNumber:i,virtualId:c,physicalId:c,sentEvents:[],isBackfilling:!1,backfillBuffer:[]}),this.virtualIdsByPhysicalId.set(c,c),this._subs[c]={tag:e,processFunc:s}})}emit(e,...t){if(E(e)){let s=!1;const r=[],o=_(e);return this._events=this._events.filter(i=>i.tag!==o?!0:(setTimeout(()=>{i.listener.apply(this,t)},0),s=!0,i.once?(r.push(i),!1):!0)),r.forEach(i=>{this._stopEvent(i)}),s}else return super.emit(e,...t)}sendBatch(e){return f(this,void 0,void 0,function*(){let t=0;const s=e.map(({method:i,params:c})=>({method:i,params:c,jsonrpc:"2.0",id:`alchemy-sdk:${t++}`})),r=yield this.sendBatchConcurrently(s),o=r.find(i=>!!i.error);if(o)throw new Error(o.error.message);return r.sort((i,c)=>i.id-c.id).map(i=>i.result)})}destroy(){return this.removeSocketListeners(),this.stopHeartbeatAndBackfill(),super.destroy()}isCommunityResource(){return this.apiKey===te}_stopEvent(e){let t=e.tag;if(O.includes(e.type)){if(this._events.filter(r=>O.includes(r.type)).length)return}else if(e.type==="tx"){if(this._events.filter(r=>r.type==="tx").length)return;t="tx"}else if(this.listenerCount(e.event))return;const s=this._subIds[t];!s||(delete this._subIds[t],s.then(r=>{!this._subs[r]||(delete this._subs[r],this.send("eth_unsubscribe",[r]))}))}addSocketListeners(){this._websocket.addEventListener("message",this.handleMessage),this._websocket.addEventListener("reopen",this.handleReopen),this._websocket.addEventListener("down",this.stopHeartbeatAndBackfill)}removeSocketListeners(){this._websocket.removeEventListener("message",this.handleMessage),this._websocket.removeEventListener("reopen",this.handleReopen),this._websocket.removeEventListener("down",this.stopHeartbeatAndBackfill)}resubscribeAndBackfill(e,t){return f(this,void 0,void 0,function*(){const{virtualId:s,method:r,params:o,sentEvents:i,backfillBuffer:c,startingBlockNumber:l}=t;t.isBackfilling=!0,c.length=0;try{const u=yield this.send(r,o);switch(b(e),t.physicalId=u,this.virtualIdsByPhysicalId.set(u,s),o[0]){case"newHeads":{const h=yield $(()=>W(this.backfiller.getNewHeadsBackfill(e,i,l),z),V,()=>!e());b(e),Te([...h,...c]).forEach(d=>this.emitNewHeadsEvent(s,d));break}case"logs":{const h=o[1]||{},a=yield $(()=>W(this.backfiller.getLogsBackfill(e,h,i,l),z),V,()=>!e());b(e),Ne([...a,...c]).forEach(m=>this.emitLogsEvent(s,m));break}default:break}}finally{t.isBackfilling=!1,c.length=0}})}emitNewHeadsEvent(e,t){this.emitAndRememberEvent(e,t,R)}emitLogsEvent(e,t){this.emitAndRememberEvent(e,t,C)}emitAndRememberEvent(e,t,s){this.rememberEvent(e,t,s);const r=this.virtualSubscriptionsById.get(e);!r||this.emitGenericEvent(r,t)}rememberEvent(e,t,s){const r=this.virtualSubscriptionsById.get(e);!r||G(r.sentEvents,Object.assign({},t),s)}emitGenericEvent(e,t){this.emitProcessFn(e.event)(t)}startHeartbeat(){this.heartbeatIntervalId==null&&(this.heartbeatIntervalId=setInterval(()=>f(this,void 0,void 0,function*(){try{yield W(this.send("net_version"),Se)}catch{this._websocket.reconnect()}}),Ae))}sendBatchConcurrently(e){return f(this,void 0,void 0,function*(){return Promise.all(e.map(t=>this.send(t.method,t.params)))})}customStartEvent(e){if(e.type===v){const{fromAddress:t,toAddress:s,hashesOnly:r}=e;this._subscribe(e.tag,[y.PENDING_TRANSACTIONS,{fromAddress:t,toAddress:s,hashesOnly:r}],this.emitProcessFn(e),e)}else if(e.type===T){const{addresses:t,includeRemoved:s,hashesOnly:r}=e;this._subscribe(e.tag,[y.MINED_TRANSACTIONS,{addresses:t,includeRemoved:s,hashesOnly:r}],this.emitProcessFn(e),e)}else e.type==="block"?this._subscribe("block",["newHeads"],this.emitProcessFn(e),e):e.type==="filter"&&this._subscribe(e.tag,["logs",this._getFilter(e.filter)],this.emitProcessFn(e),e)}emitProcessFn(e){switch(e.type){case v:return t=>this.emit({method:y.PENDING_TRANSACTIONS,fromAddress:e.fromAddress,toAddress:e.toAddress,hashesOnly:e.hashesOnly},t);case T:return t=>this.emit({method:y.MINED_TRANSACTIONS,addresses:e.addresses,includeRemoved:e.includeRemoved,hashesOnly:e.hashesOnly},t);case"block":return t=>{const s=J.from(t.number).toNumber();this._emitted.block=s,this.emit("block",s)};case"filter":return t=>{t.removed==null&&(t.removed=!1),this.emit(e.filter,this.formatter.filterLog(t))};default:throw new Error("Invalid event type to `emitProcessFn()`")}}_off(e,t){if(t==null)return this.removeAllListeners(e);const s=[];let r=!1;const o=_(e);return this._events=this._events.filter(i=>i.tag!==o||i.listener!=t||r?!0:(r=!0,s.push(i),!1)),s.forEach(i=>{this._stopEvent(i)}),this}_removeAllListeners(e){let t=[];if(e==null)t=this._events,this._events=[];else{const s=_(e);this._events=this._events.filter(r=>r.tag!==s?!0:(t.push(r),!1))}return t.forEach(s=>{this._stopEvent(s)}),this}_listenerCount(e){if(!e)return this._events.length;const t=_(e);return this._events.filter(s=>s.tag===t).length}_listeners(e){if(e==null)return this._events.map(s=>s.listener);const t=_(e);return this._events.filter(s=>s.tag===t).map(s=>s.listener)}}function Oe(){return Re()?require("websocket").w3cwebsocket:WebSocket}function Re(){return typeof process!="undefined"&&process!=null&&process.versions!=null&&process.versions.node!=null}function Ce(){let n=!1;return{cancel:()=>n=!0,isCancelled:()=>n}}const Le=1e3,Pe=2,xe=3e4;function $(n,e,t=()=>!0){return f(this,void 0,void 0,function*(){let s=0,r=0;for(;;)try{return yield n()}catch(o){if(r++,r>=e||!t(o)||(yield He(s),!t(o)))throw o;s=s===0?Le:Math.min(xe,Pe*s)}})}function He(n){return new Promise(e=>setTimeout(e,n))}function W(n,e){return Promise.race([n,new Promise((t,s)=>setTimeout(()=>s(new Error("Timeout")),e))])}function R(n){return p(n.number)}function C(n){return p(n.blockNumber)}function Fe(n){return Array.isArray(n)||n.jsonrpc==="2.0"&&n.id!==void 0}function De(n){return!Fe(n)}function Me(n,e){G(n,e,R)}function We(n,e){G(n,e,C)}function G(n,e,t){const s=t(e),r=n.findIndex(o=>t(o)>s-Be);r===-1?n.length=0:n.splice(0,r),n.push(e)}export{Ge as AlchemyWebSocketProvider};
